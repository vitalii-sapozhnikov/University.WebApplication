@model List<PublicationShortDto>
@{
    bool authorized = SessionService.isAuthorized;
    var (user, role) = SessionService.GetUser();
    var cats = (SelectList)ViewBag.Categories;
}
<style>
    .publication-title {
        font-size: 18px;
        font-weight: 600;
        text-decoration: none;
    }

    .publication-title:hover {
        text-decoration: underline; /* Underline on hover */
    }

    .author-list {
        text-decoration: none;
        font-size: 0.95rem;

        white-space: nowrap;
        display: inline-block; /* Ensure it respects nowrap property */
        color: #d63384;
        word-wrap: break-word;
        font-family: var(--bs-font-monospace);
        direction: ltr;
        unicode-bidi: bidi-override;
    }

    .author-list:hover {
        text-decoration: underline;
        color: #d63384;
    }

    .comma {
        color: #d63384; /* Comma color */
    }

    .publication-description{
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Limit to two lines */
        -webkit-box-orient: vertical;

        margin-bottom: .3rem;
    }

    .chosen-container-multi {
        border: none;
    }

    .chosen-container-multi .chosen-choices {
        background-image: none;
        padding: 7px;
        border: none !important;
        border-radius: 4px;
        -webkit-box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1) !important;
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1) !important;
    }

    .chosen-container-multi .chosen-choices li.search-choice {
        -webkit-box-shadow: none;
        box-shadow: none;
        padding-top: 7px;
        padding-bottom: 7px;
        padding-left: 10px;
        padding-right: 26px;
        border: none;
        background-image: none;
    }

    .chosen-container-multi .chosen-choices li.search-choice .search-choice-close {
        top: 9px;
        right: 8px;
    }

    .chosen-container-multi .chosen-choices li.search-field input[type="text"] {
        height: 32px;
        font-size: 14px;
    }

    .chosen-container .chosen-drop {
        border: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        margin-top: 3px;
        border-radius: 4px;
        -webkit-box-shadow: 0 15px 30px 0 rgba(0, 0, 0, 0.2) !important;
        box-shadow: 0 15px 30px 0 rgba(0, 0, 0, 0.2) !important;
    }

    .color-1 .chosen-container-multi .chosen-choices li.search-choice {
        background-color: #e5e4cc;
    }

    .color-2 .chosen-container-multi .chosen-choices li.search-choice {
        background-color: #c7f0db;
    }

    .color-3 .chosen-container-multi .chosen-choices li.search-choice {
        background-color: #d3f4ff;
    }
</style>

<div class="d-flex justify-content-between">
    <h3>Публікації</h3>
    @if(authorized && role != Roles.GuarantorOfSpeciality && role != Roles.EducationDepartment)
    {
        <div class="nav-item dropdown active">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Опублікувати</a>
            <div class="dropdown-menu" style="">
                <h6 class="dropdown-header">Створити публікацію</h6>
                <a asp-controller="Publications"
                   asp-action="UploadPublication"
                   class="dropdown-item">
                    Методична
                </a>
                <div class="dropdown-divider"></div>
                <a asp-controller="Publications"
                   asp-action="UploadScientificPublication"
                   class="dropdown-item">
                    Наукова стаття
                </a>
                <a asp-controller="Publications"
                   asp-action="UploadMonograph"
                   class="dropdown-item">
                    Монографія
                </a>
                <a asp-controller="Publications"
                   asp-action="UploadDissertation"
                   class="dropdown-item">
                    Дисертація
                </a>
                <a asp-controller="Publications"
                   asp-action="UploadPatent"
                   class="dropdown-item">
                    Патент
                </a>
                <a asp-controller="Publications"
                   asp-action="UploadConferenceTheses"
                   class="dropdown-item">
                    Тези конференції
                </a>
            </div>
        </div>
    }

</div>

<hr/>

<!-- Search Form -->
<form id="searchForm" asp-action="All" asp-controller="Publications" method="get" class="mb-3">

    <div class="input-group">
        <input type="search" id="searchTerm" name="searchTerm" class="form-control" placeholder="Пошук" value="@ViewBag.SearchTerm"/>
        <button type="submit" class="btn btn-primary" data-mdb-ripple-init>
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </div>
    
    <div class="mt-3">
        <a data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample" class="advanced">
            Розширений пошук <i class="fa fa-angle-down"></i>
        </a>
        <div class="collapse mt-2" id="collapseExample">
            <div class="card card-body">
                <div class="row mt-1 align-items-end">
                    <div class="col-md-6">
                        <label for="authorName">Автор:</label>
                        <input type="text"
                               class="form-control mt-1"
                               id="authorName"
                               name="authorName"
                               placeholder="Ім'я автора"
                               value="@ViewBag.AuthorName"/>
                    </div>
                    <div class="col-md-3">
                        <label for="startDateFilter">Від:</label>
                        <input type="date"
                               class="form-control mt-1"
                               id="startDateFilter"
                               name="startDateFilter"
                               placeholder="Дата початку"
                               value="@(ViewBag.StartDateFilter == null ? "" : ((DateTime)ViewBag.StartDateFilter).ToString("yyyy-MM-dd"))"/>
                    </div>
                    <div class="col-md-3">
                        <label for="endDateFilter">До:</label>
                        <input type="date"
                               class="form-control mt-1"
                               id="endDateFilter"
                               name="endDateFilter"
                               placeholder="Дата завершення"
                               value="@(ViewBag.EndDateFilter == null ? "" : ((DateTime)ViewBag.EndDateFilter).ToString("yyyy-MM-dd"))" />
                    </div>
                </div>
                <div class="mt-2">
                    <label for="categories">Дисципліни:</label>
                    <select name="categories" asp-items="ViewBag.Categories" multiple class="form-control" data-placeholder="Оберіть дисципліну" id="DisciplinesSelect"></select>
                </div>
            </div>
        </div>
    </div>
</form>

<table id="publicationTable" class="display">
    <tbody>
    @foreach (var publication in Model)
    {
        <tr>
            <td>
                <div class="py-1">
                    <div>
                        <a class="text-dark publication-title"
                           asp-controller="Publications"
                           asp-action="Index"
                           asp-route-id="@publication.PublicationId">
                            @publication.Title &mdash; @publication.PublicationDate.Year.ToString()
                        </a>
                    </div>
                    <div>
                        @foreach (var author in publication.Lecturers)
                        {
                            <a class="author-list"
                               asp-controller="Lecturers"
                               asp-action="Index"
                               asp-route-id="@author.Id">
                                @author.LastName @author.FirstName @author.MiddleName
                            </a>
                            @if (!author.Equals(publication.Lecturers.Last()))
                            {
                                <span class="comma">,&nbsp;</span>
                            }
                        }
                    </div>
                    <div>
                        <p class="publication-description">@publication.Description</p>
                    </div>
                    <div>
                        @foreach (var keyWord in publication.Keywords)
                        {
                            <span class="badge bg-primary">
                                @keyWord
                            </span>
                        }
                    </div>
                </div>
            </td>
        </tr>
    }
    </tbody>
</table>

<script>
    $(document).ready(function () {
        $('#publicationTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/uk.json"
            },
            "columns": [
                null  // Placeholder for the second column
            ], 
            "searching": false,
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/js/multi-select-tag.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastr@2/build/toastr.min.js" defer></script>
<script>

    $(function () {
        new MultiSelectTag('DisciplinesSelect', {
            rounded: true,    // default true
            shadow: false,      // default false
            placeholder: 'Пошук',  // default Search...
            tagColor: {
                textColor: '#327b2c',
                borderColor: '#92e681',
                bgColor: '#eaffe6',
            },
            onChange: function (values) {
                console.log(values)
            }
        });
        var getAuthorsUrl = "/Lecturers/GetAuthors"; // Adjust the URL to your actual endpoint

        function split(val) {
            return val.split(/,\s*/);
        }

        function extractLast(term) {
            var terms = split(term);
            return terms.length === 1 ? terms[0] : terms.pop();
        }

        $("#authorName")
            .on("keydown", function (event) {
                if (event.keyCode === $.ui.keyCode.TAB &&
                    $(this).autocomplete("instance").menu.active) {
                    event.preventDefault();
                }
            })
            .autocomplete({
                minLength: 3,
                source: function (request, response) {
                    $.ajax({
                        url: getAuthorsUrl,
                        data: { term: extractLast(request.term) }, // Use extractLast to get the correct term
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                focus: function () {
                    return false;
                },
                select: function (event, ui) {
                    var terms = split(this.value);
                    terms.pop();
                    terms.push(ui.item.value);
                    terms.push("");
                    this.value = terms.join(", ");
                    return false;
                }
            });
    });
</script>